name: Discord Commit Notifications

on:
  push:
    branches:
      - main

jobs:
  notify:
    name: Send commit to Discord
    runs-on: ubuntu-latest
    steps:
      - name: Send notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Exit if webhook not configured
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK_URL secret not set, skipping notification"
            exit 0
          fi

          # Extract commit info (safely handle multiline messages)
          COMMIT_MSG=$(cat << 'EOF'
          ${{ github.event.head_commit.message }}
          EOF
          )
          BRANCH="${{ github.ref_name }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          COMMIT_SHA="${{ github.sha }}"

          # Format timestamp (ISO to readable)
          TIMESTAMP="${{ github.event.head_commit.timestamp }}"
          FORMATTED_DATE=$(echo "$TIMESTAMP" | sed 's/T/ /; s/Z//; s/-[0-9][0-9]:[0-9][0-9]$//')

          # Build and send payload using jq
          jq -n \
            --arg branch "$BRANCH" \
            --arg sha "${COMMIT_SHA:0:7}" \
            --arg author "$AUTHOR" \
            --arg timestamp "$FORMATTED_DATE" \
            --arg commit_msg "$COMMIT_MSG" \
            --arg url "$COMMIT_URL" \
            '{content: "**[Claude Commands] New commit on `\($branch)`**\n```\nCommit: \($sha)\nAuthor: \($author)\nDate:   \($timestamp)\n\n\($commit_msg)\n```\nView: \($url)"}' \
          | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
